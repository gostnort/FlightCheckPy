# HBPR 处理系统 - Web 界面

基于 Streamlit 的 HBPR 乘客记录处理和验证的综合 Web 界面。

## 🚀 快速开始

## 📋 功能特性

### 🏠 主页
- **系统概览**: 实时数据库统计信息
- **HBNB 范围信息**: 显示最小/最大值、总数、缺失号码
- **缺失号码表格**: 分页显示缺失的 HBNB 号码
- **快速操作**: 直接访问主要功能

### 🗄️ 数据库
- **构建数据库**: 从 HBPR 列表文件创建数据库（自动保存到 `databases` 文件夹）
- **数据库信息**: 查看表结构和统计信息
- **数据库维护**: 删除选定的数据库文件

### 🔍 处理记录
- **🚀 Process All Records**: 批量处理所有记录，支持错误分析和状态跟踪
- **✏️ Add/Edit Record**: 按 HBNB 号码查看和编辑单个 HBPR 记录
- **🧻 Simple Record**: 创建和管理简单的 HBNB 记录
- **📋 Sort Records**: 浏览和筛选已处理的记录，支持多种排序和过滤选项
- **📤 Export Data**: 以 CSV 或原始文本格式导出数据

### 📋 其他命令
- **📥 Import Commands**: 导入和处理航空公司命令文件
- **✒️ Add/Edit Data**: 添加和编辑命令数据（支持原始内容存储）
- **📊 View Data**: 查看命令数据和记录，支持导出
- **📅 Timeline**: 按命令查看版本时间线，支持版本对比与恢复
- **🗃️ Maintain**: 迁移/清理命令数据，统计信息

### 📊 Excel 处理器
- **上传 Excel**: 支持 XLS/XLSX（XLS 需要 `xlrd`，XLSX 使用 `openpyxl`）
- **严格表头校验**: 第二行为表头（header=1），列名/序号严格匹配
- **TKNE 匹配**: 基于 TKNE 关联数据库中的 CKIN CCRD 信息
- **Debug 模式**: 展示每行输入与输出详情
- **EMD 输出**: 使用模板生成格式化 EMD 工作簿（支持下载/保存到本地）

### ⚙️ 设置
- **UI 偏好**: 主题和显示选项
- **处理设置**: 批处理大小和默认值
- **关于**: 系统信息和版本详情

## 🆕 新增功能

### 数据库选择
- **智能数据库搜索**: 优先在 `databases` 文件夹中查找数据库文件
- **数据库信息显示**: 显示航班信息和日期，便于识别
- **状态指示器**: 使用 ✅ 标记显示数据库状态
- **自动文件夹创建**: 如果 `databases` 文件夹不存在，提供创建选项

### 完整 HBPR 记录输入
- **预处理信息显示**: 显示数据库航班信息和 HBNB 状态
- **航班信息验证**: 检查输入记录与数据库航班信息是否匹配
- **智能记录替换**: 
  - 如果 HBNB 已存在完整记录，替换现有记录
  - 如果 HBNB 存在简单记录，删除简单记录并创建完整记录
  - 如果 HBNB 不存在，创建新记录
- **自动缺失号码更新**: 创建记录后自动更新 `missing_numbers` 表

### 简单 HBNB 记录输入
- **灵活输入格式**: 支持单个数字、范围（如 "400-410"）和逗号分隔列表（如 "400-410,412"）
- **批量创建**: 一次输入可创建多个简单记录
- **状态预览**: 显示前 5 个 HBNB 号码的状态（完整记录存在/简单记录存在/可用）
- **进度跟踪**: 批量处理时显示进度条和状态更新
- **处理摘要**: 显示创建、跳过和错误的统计信息
- **智能跳过**: 自动跳过已存在的记录，避免重复创建

### 输入格式说明
- **单个数字**: `400`
- **数字范围**: `400-410` （自动交换顺序，如 410-400 会变成 400-410）
- **混合格式**: `400-410,412,415-420`
- **有效范围**: 1-99999

## 🛠️ 使用工作流程

1. **构建数据库**
   - 前往"数据库" → "构建数据库"
   - 上传您的 `sample_hbpr_list.txt` 文件或使用默认文件
   - 点击"从默认文件构建"或"从上传文件构建"
   - 数据库将自动保存到 `databases` 文件夹

2. **处理记录**
   - 前往"处理记录"页面
   - 选择相应的子功能标签页：
     - **Process All Records**: 批量处理所有记录，点击"🚀 Start Processing"
     - **Add/Edit Record**: 按 HBNB 号码、座位号、姓名等方式查看和编辑单个记录
     - **Simple Record**: 批量创建简单的 HBNB 记录
     - **Sort Records**: 查看已处理记录的表格，支持筛选和排序
     - **Export Data**: 导出数据为 CSV 或原始文本格式

3. **其他命令处理**（含时间线）
   - 前往"其他命令"页面
   - 选择相应的子功能标签页：
     - **Import Commands**: 上传并导入航空公司命令文件
     - **Add/Edit Data**: 手动添加或编辑命令数据
     - **View Data**: 查看已导入的命令数据
     - **Statistics**: 查看命令处理统计信息

4. **查看和导出结果**（含 Excel 处理器）
   - 在"处理记录" → "Sort Records"中查看处理结果表格
   - 使用筛选选项按舱位、常旅客等级、值机类型等筛选记录
   - 在"处理记录" → "Export Data"中导出数据
   - 支持 CSV 和原始文本格式导出

## 📊 数据导出与 Excel 生成

系统支持以两种格式导出处理后的数据，并可从 Excel 处理器生成格式化的 EMD 工作簿：

- **CSV**: 逗号分隔值，适用于一般用途
- **Excel**: 格式化的电子表格（EMD 模板），包含所有字段

导出/生成文件包括：
- 所有 CHbpr 提取字段（姓名、座位、舱位、目的地等）
- 验证状态和错误信息
- 处理时间戳
- TKNE 匹配的 CKIN CCRD 字段（L/M/N/O/P 列）

## 🔧 技术详情

### 架构
- **前端**: Streamlit Web 框架
- **后端**: `hbpr_info_processor.py` 包含 `CHbpr` 和 `HbprDatabase` 类
- **数据库**: SQLite，支持动态字段添加
- **数据处理**: Pandas 用于分析和导出

### 数据库架构
系统将 CHbpr 字段添加到现有的 `hbpr_full_records` 表：
- 验证字段：`is_validated`, `is_valid`, `error_count`, `error_messages`
- 乘客字段：`pnr`, `name`, `seat`, `class`, `destination`
- 行李字段：`bag_piece`, `bag_weight`, `bag_allowance`
- 特殊字段：`ff`, `pspt_name`, `pspt_exp_date`, `ckin_msg`
- 处理时间戳：`validated_at`

### 数据库文件夹组织
- **默认位置**: `databases/` 文件夹
- **自动创建**: 如果文件夹不存在，系统会提示创建
- **回退机制**: 如果 `databases` 文件夹中没有数据库，会搜索根目录
- **文件命名**: 数据库文件以航班号命名（如 `CA123_20231201.db`）

## 🚨 错误处理

UI 包含全面的错误处理：
- 数据库连接错误
- 文件上传验证
- 处理异常，包含详细消息
- 缺失数据的优雅回退
- 输入格式验证和错误提示

## 🎯 性能

- **批量处理**: 针对处理多条记录进行优化
- **进度跟踪**: 实时进度条和状态更新
- **内存高效**: 大数据集的流式数据处理
- **响应式 UI**: 快速加载和交互式组件
- **智能缓存**: 数据库查询结果缓存

## 🔒 数据安全

- **本地处理**: 所有数据都保存在您的本地机器上
- **无外部连接**: Streamlit 默认在本地运行
- **文件验证**: 上传验证和清理
- **错误隔离**: 处理错误不会影响其他记录
- **数据完整性**: 自动更新 `missing_numbers` 表保持数据一致性

## 🎨 界面特性

### 导航系统
- **侧边栏导航**: 使用按钮式导航，无需下拉选择框
- **页面状态管理**: 使用 Streamlit session state 保持页面状态
- **响应式布局**: 宽屏布局，充分利用屏幕空间
- **简化导航**: 数据库管理页面名称简化为"数据库"

### 图标和品牌
- **自定义图标**: 使用 `fcp.ico` 作为页面图标和标题图标
- **品牌标识**: 主页显示完整的品牌标题和图标
- **页面优化**: 其他页面使用全屏显示，最大化内容空间

### 用户体验改进
- **状态指示器**: 使用图标和颜色编码显示状态
- **进度反馈**: 批量操作时显示进度条和状态文本
- **信息摘要**: 处理完成后显示详细的统计摘要
- **智能提示**: 根据操作结果提供相应的提示信息

## 📝 使用技巧

1. **数据库管理**: 在处理之前先构建数据库
2. **批处理大小**: 测试时从小批量开始（10-20）
3. **定期导出**: 处理会话后保存结果
4. **筛选数据**: 使用记录表格筛选器查找特定记录
5. **手动输入**: 用于测试单个 HBPR 内容片段
6. **简单记录**: 使用范围输入快速创建多个占位符记录
7. **文件夹组织**: 将数据库文件保存在 `databases` 文件夹中以保持整洁

## 🔄 更新

要更新系统：
1. 从仓库拉取最新更改
2. 重启 Streamlit 应用程序
3. 刷新浏览器

## 📞 支持

如有问题或疑问：
- 检查 UI 中的错误消息
- 查看处理结果中的调试信息
- 确保所有依赖项都正确安装
- 验证数据库文件是否在正确的位置 