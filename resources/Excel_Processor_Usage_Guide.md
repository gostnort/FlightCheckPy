# Excel处理器使用指南 (EMD销售日报处理)

## 📋 功能概述

Excel处理器专门用于处理EMD销售日报文件，能够：
1. 导入EMD销售日报Excel文件（xlsx/xls格式）
2. 根据关联ET(TKNE)号码查找数据库中的对应HBPR记录
3. 解析CKIN CCRD信息并生成标准化输出
4. 生成符合指定格式的输出Excel文件

## 🚀 使用步骤

### 1. 准备输入文件
确保你的Excel文件是**EMD销售日报格式**，包含以下必要列：
- **EMD**: EMD号码
- **关联ET**: TKNE号码（用于数据库查询）
- **旅客姓名**: 乘客姓名
- **航班号**: 航班信息
- **航程**: 航线信息
- **操作**: 操作类型
- **实收金额**: 金额信息
- **工作号**: 工作编号
- **操作时间**: 操作时间
- **产品类型**: 服务类型（逾重PC/选座/升舱等）

### 2. 访问Excel处理器
1. 在侧边栏导航中点击 **"📊 Excel Processor"**
2. 确保已选择正确的HBPR数据库

### 3. 上传和处理文件
1. 点击文件上传区域选择你的EMD销售日报Excel文件
2. 系统会自动跳过标题行并显示文件预览和列映射信息
3. 确认文件格式正确后，点击 **"🚀 开始处理"**

### 4. 查看结果
- **处理结果表**: 显示转换后的数据
- **未处理记录**: 显示无法解析的CKIN CCRD记录
- **下载输出**: 点击下载按钮获取结果文件

## 📊 列映射规则

根据EMD销售日报的实际列结构：

| EMD销售日报列名 | 映射到输出列 | 说明 |
|----------------|-------------|------|
| EMD | A列 | EMD号码 |
| 旅客姓名 | B列 | 乘客姓名 |
| 航程 | C列 | 航线信息 |
| 操作 | E列 | 操作类型 |
| 实收金额 | K列 | 金额信息 |
| 工作号 | F列 | 工作编号 |
| 操作时间 | G列 | 操作时间 |
| 产品类型 | H列 | 服务类型（有翻译） |
| 航班号 | J列 | 航班信息 |
| 关联ET | - | 用于TKNE查询 |

### 固定值
- **D列**: 总是填入 "1"
- **I列**: 总是填入 "International"

### 翻译规则

#### 产品类型翻译规则（映射到H列）
- `逾重PC` → `EXPC`
- `选座` → `SEAT`
- `升舱` → `UPG`
- 其他内容 → 原样保留

#### 操作翻译规则（映射到E列）
- `出票` → `Issue`
- 其他内容 → 原样保留

## 🔍 CKIN CCRD处理逻辑

系统会根据关联ET(TKNE)在数据库中查找对应的HBPR记录，并解析CKIN CCRD信息：

### CASH类型
格式：`CKIN CCRD CASH [金额]`
- 金额 → L列

### 卡号类型（2字母+4数字）
格式：`CKIN CCRD [XX1234] [ITEM2] [ITEM3...]`

#### AX开头的卡号
- 4位数字 → O列
- ITEM2 → M列
- ITEM3及后续 → P列

#### 其他卡号
- 4位数字 → O列  
- ITEM2 → N列
- ITEM3及后续 → P列

## ⚠️ 注意事项

1. **文件格式要求**: 必须是EMD销售日报格式的Excel文件
2. **数据库要求**: 必须先选择包含HBPR记录的数据库
3. **TKNE匹配**: 系统根据关联ET列的TKNE号码在数据库中查找对应记录
4. **CKIN CCRD**: 只有包含CKIN CCRD信息的记录才会被处理
5. **未处理记录**: 无法解析的CKIN CCRD记录会显示在结果中供手动处理

## 📁 输出文件结构

生成的Excel文件包含两个工作表：
1. **DATA**: 主要的处理结果数据
2. **SUM**: 未处理的CKIN CCRD记录（从C15行开始）

## 🛠️ 故障排除

### 常见问题
1. **"缺少必要的列"**: 检查Excel文件是否是EMD销售日报格式
2. **"未选择数据库"**: 从侧边栏选择一个有效的HBPR数据库文件
3. **"没有找到TKNE记录"**: 确认数据库中存在对应的TKNE记录

### 性能建议
- 建议单次处理文件行数不超过1000行
- 确保数据库文件大小合理以提高查询速度

## 📝 文件格式示例

EMD销售日报的标准格式应包含以下结构：
```
第1行: EMD销售日报2025-07-26 00:00:00~2025-07-26 23:59:59 (标题行，会被跳过)
第2行: NO. | EMD | 关联ET | 旅客姓名 | 航班号 | 航程 | ... (列标题)
第3行及之后: 实际数据行
```

系统会自动跳过第一行标题，从第二行开始读取列名和数据。